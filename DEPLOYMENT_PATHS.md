# NAIA Deployment Paths Reference

This document clarifies the correct deployment paths for the NAIA system.

## Important Directory Structure

```
/opt/naia/
├── build/                    ← UI DEPLOYMENT TARGET (Caddy serves from here)
├── publish/                  ← API binaries (dotnet publish output)
│   ├── Naia.Api.dll
│   └── wwwroot/             ← NOT USED (API doesn't serve static files)
├── src/                      ← Git repository source code
│   ├── Naia.Api/
│   ├── Naia.Web/
│   │   └── build/           ← UI build output (not in git)
│   └── ...
```

## Key Points

### UI (Frontend)
- **Source**: `/opt/naia/src/Naia.Web/`
- **Build output**: `/opt/naia/src/Naia.Web/build/` (generated by `npm run build`)
- **Deployment target**: `/opt/naia/build/` ← **Caddy serves static files from here**
- **NOT used**: `/opt/naia/api/wwwroot/` (this directory doesn't exist in production)
- **NOT used**: `/opt/naia/publish/wwwroot/` (API doesn't serve static files)

### API (Backend)
- **Source**: `/opt/naia/src/Naia.Api/`
- **Build output**: `/opt/naia/src/Naia.Api/bin/Release/net8.0/`
- **Deployment target**: `/opt/naia/publish/` ← **API runs from here**
- **Service**: `naia-api.service` runs `/opt/naia/publish/Naia.Api.dll`

## Services Configuration

### Caddy (Reverse Proxy)
- **Config**: `/etc/caddy/Caddyfile`
- **Static files**: `root * /opt/naia/build`
- **API proxy**: Routes `/api/*`, `/hubs/*`, `/health`, `/hangfire*` to API on port 5000

### NAIA API
- **Service file**: `/etc/systemd/system/naia-api.service`
- **Working directory**: `/opt/naia/publish`
- **Entry point**: `/usr/bin/dotnet /opt/naia/publish/Naia.Api.dll`

## Deployment Workflows

### UI Only (Frontend Changes)
```bash
cd /opt/naia && git pull
cd src/Naia.Web && npm run build
rm -rf /opt/naia/build && cp -r build /opt/naia/build
sudo systemctl restart caddy
```

### API Only (Backend Changes)
```bash
cd /opt/naia && git pull
dotnet publish -c Release -o /opt/naia/publish
sudo systemctl restart naia-api
```

### Full Deployment (Both)
```bash
cd /opt/naia && git pull

# Build and deploy UI
cd src/Naia.Web && npm run build
rm -rf /opt/naia/build && cp -r build /opt/naia/build

# Build and deploy API
cd /opt/naia
dotnet publish -c Release -o /opt/naia/publish

# Restart services
sudo systemctl restart caddy
sudo systemctl restart naia-api
```

## Common Mistakes to Avoid

❌ **WRONG**: Deploying UI to `/opt/naia/api/wwwroot/`
✓ **CORRECT**: Deploy UI to `/opt/naia/build/`

❌ **WRONG**: Expecting API to serve static files from its wwwroot
✓ **CORRECT**: Caddy serves static files, API only handles `/api/*` routes

❌ **WRONG**: Only restarting API after UI changes
✓ **CORRECT**: Restart Caddy after UI changes

## Verification Commands

```bash
# Check UI deployment
ls -la /opt/naia/build/index.html
curl -s https://app.naia.run/ | grep -o 'start\.[A-Za-z0-9]*'

# Check API deployment
ls -la /opt/naia/publish/Naia.Api.dll
sudo systemctl status naia-api

# Check Caddy config
sudo cat /etc/caddy/Caddyfile | grep "root \*"
sudo systemctl status caddy
```

## Build Output Locations (gitignored)

These directories are in `.gitignore` and generated during build:
- `src/Naia.Web/build/` - UI build output from `npm run build`
- `src/Naia.Web/.svelte-kit/` - SvelteKit build cache
- `src/*/bin/` and `src/*/obj/` - .NET build outputs

Only source files are committed to git. Builds happen on the server after `git pull`.
